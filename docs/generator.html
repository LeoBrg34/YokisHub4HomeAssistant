<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>YokisHub4HomeAssistant ‚Äî Constructeur de commande YAML</title>
<style>
  :root { --bg:#0b0f14; --card:#121822; --muted:#8aa0b5; --text:#e8f0f7; --accent:#34c759; --accent2:#0a84ff; }
  html,body{background:var(--bg); color:var(--text); font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; margin:0; padding:0;}
  .container{max-width:1024px; margin:0 auto; padding:24px;}
  h1{font-size:28px; margin:0 0 8px;}
  p.lead{color:var(--muted); margin:0 0 24px;}
  .grid{display:grid; grid-template-columns:1fr; gap:16px;}
  @media(min-width:880px){ .grid{grid-template-columns: 1.2fr 1fr; } }
  .card{background:var(--card); border:1px solid #1e2735; border-radius:16px; padding:16px;}
  .card h2{font-size:18px; margin:0 0 12px;}
  label{display:block; font-size:13px; color:var(--muted); margin:8px 0 6px;}
  input,select{width:100%; padding:10px 12px; border-radius:10px; border:1px solid #263141; background:#0f1520; color:var(--text); outline:none;}
  input::placeholder{color:#789;}
  .row{display:grid; grid-template-columns:1fr 1fr; gap:12px;}
  .btn{display:inline-block; padding:10px 14px; border-radius:10px; border:1px solid #2b3a4f; background:#121a28; color:#fff; cursor:pointer; user-select:none;}
  .btn.primary{background:linear-gradient(90deg,var(--accent),#28b14f); border-color:transparent; font-weight:600;}
  .btn.secondary{background:linear-gradient(90deg,var(--accent2),#0f6fe6); border-color:transparent; font-weight:600;}
  .out{position:relative;}
  pre{margin:0; padding:14px; background:#0a0f17; border:1px solid #1e2735; border-radius:12px; overflow:auto; max-height:420px; font-size:12.5px; line-height:1.4;}
  .actions{display:flex; gap:8px; margin-top:10px; flex-wrap:wrap;}
  .badge{display:inline-block; padding:6px 10px; border-radius:999px; font-size:12px; background:#0f1b2a; border:1px solid #203048; color:#9ec4ff;}
  .tips{font-size:13px; color:#9bb2c8;}
  .footer{margin-top:24px; font-size:12.5px; color:#8aa0b5;}
  .ok{border-color:#2c5;}
  a { color:#8ec1ff; text-decoration: none; }
  a:hover { text-decoration: underline; }
</style>
</head>
<body>
  <div class="container">
    <h1>üß∞ YokisHub4HomeAssistant ‚Äî Constructeur de commande YAML</h1>
    <p class="lead">G√©n√©rez automatiquement vos blocs <code>rest_command</code>, <code>sensor</code>, <code>light/cover/switch</code> pour Home Assistant √† partir de l‚ÄôIP du Hub, l‚ÄôUID du module et votre token <strong>HTTP Basic (Base64)</strong>.</p>

    <div class="grid">
      <!-- FORM -->
      <div class="card">
        <h2>üéõÔ∏è Param√®tres</h2>

        <label for="type">Type d‚Äô√©quipement</label>
        <select id="type">
          <option value="light">Lampe</option>
          <option value="cover">Volet roulant</option>
          <option value="switch">Interrupteur</option>
        </select>

        <div class="row">
          <div>
            <label for="friendly">Nom d‚Äôaffichage (friendly_name)</label>
            <input id="friendly" placeholder="Ex: Lumi√®re Terrasse / Volet Chambre / Interrupteur Garage" />
          </div>
          <div>
            <label for="slug">Identifiant interne (slug court, a‚Äìz0‚Äì9_)</label>
            <input id="slug" placeholder="Ex: lumiere_terrasse / volet_chambre_leo / interrupteur_garage" />
          </div>
        </div>

        <div class="row">
          <div>
            <label for="ip">IP du Yokis Hub</label>
            <input id="ip" placeholder="Ex: 192.168.0.156" />
          </div>
          <div>
            <label for="uid">UID du module Yokis</label>
            <input id="uid" placeholder="Ex: A111FCC0 / C84315B9" />
          </div>
        </div>

        <label for="token">Token HTTP Basic (Base64) <span class="badge">format: Authorization: "Basic &lt;TOKEN&gt;"</span></label>
        <input id="token" placeholder="Ex: QWxhZGRpbjpPcGVuU2VzYW1l" />

        <div class="row">
          <div>
            <label for="scan">scan_interval (s)</label>
            <input id="scan" type="number" min="1" value="5" />
          </div>
          <div>
            <label for="entityPrefix">Pr√©fixe de service (facultatif)</label>
            <input id="entityPrefix" placeholder="Ex: yokis (donnera rest_command.yokis_...)" />
          </div>
        </div>

        <div class="actions">
          <button class="btn primary" id="buildBtn">G√©n√©rer le YAML</button>
          <button class="btn" id="resetBtn">R√©initialiser</button>
          <span class="tips">Besoin d‚Äôaide ? <a href="./get-token.md">R√©cup√©rer le token</a> ¬∑ <a href="./get-module-id.md">R√©cup√©rer l‚ÄôUID</a></span>
        </div>
      </div>

      <!-- OUTPUTS -->
      <div class="card out">
        <h2>üß© Blocs YAML g√©n√©r√©s</h2>

        <h3>1) <code>rest_command</code></h3>
        <pre id="outRest"># G√©n√©r√© ici‚Ä¶</pre>
        <div class="actions">
          <button class="btn secondary" data-copy="#outRest">Copier</button>
        </div>

        <h3>2) <code>sensor</code> (lecture √©tat depuis server.xml)</h3>
        <pre id="outSensor"># G√©n√©r√© ici‚Ä¶</pre>
        <div class="actions">
          <button class="btn secondary" data-copy="#outSensor">Copier</button>
        </div>

        <h3>3) Entit√© Home Assistant (<code>light</code> / <code>cover</code> / <code>switch</code>)</h3>
        <pre id="outEntity"># G√©n√©r√© ici‚Ä¶</pre>
        <div class="actions">
          <button class="btn secondary" data-copy="#outEntity">Copier</button>
        </div>

        <h3>4) Tout-en-un (<code>configuration.yaml</code>)</h3>
        <pre id="outAll"># G√©n√©r√© ici‚Ä¶</pre>
        <div class="actions">
          <button class="btn secondary" id="copyAllBtn">Copier tout</button>
          <button class="btn" id="downloadBtn">T√©l√©charger .yaml</button>
        </div>

        <div class="footer">
          üì∏ Guides illustr√©s (captures Android) : <a href="./get-token.md">Token</a> ¬∑ <a href="./get-module-id.md">UID</a> ‚Äî Une version iOS est envisag√©e pour une prochaine release.
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  const $ = (sel)=>document.querySelector(sel);
  const byId = (id)=>document.getElementById(id);

  const elType = byId('type');
  const elFriendly = byId('friendly');
  const elSlug = byId('slug');
  const elIP = byId('ip');
  const elUID = byId('uid');
  const elToken = byId('token');
  const elScan = byId('scan');
  const elPrefix = byId('entityPrefix');

  const outRest = byId('outRest');
  const outSensor = byId('outSensor');
  const outEntity = byId('outEntity');
  const outAll = byId('outAll');

  function sanitizeSlug(s){
    return (s||'').toLowerCase().trim()
      .replace(/\s+/g,'_')
      .replace(/[^a-z0-9_]/g,'')
      .replace(/^_+|_+$/g,'');
  }
  function ensure(val, fallback){ return (val && String(val).trim().length)? String(val).trim() : fallback; }

  function buildLight({friendly, slug, ip, uid, token, scan, prefix}){
    const prefixCmd = prefix ? `${prefix}_` : '';
    const rest_on = `yokis_${prefixCmd}${slug}_on`;
    const rest_off = `yokis_${prefixCmd}${slug}_off`;
    const sensor_name = friendly + ' Etat';
    const sensor_key = sanitizeSlug(friendly)+'_etat';

    const REST =
`rest_command:
  ${rest_on}:
    url: "http://${ip}/command.xml?action=order&id=${uid}&order=on"
    method: get
    headers:
      Authorization: "Basic ${token}"
  ${rest_off}:
    url: "http://${ip}/command.xml?action=order&id=${uid}&order=off"
    method: get
    headers:
      Authorization: "Basic ${token}"`;

    const SENSOR =
`sensor:
  - platform: rest
    name: ${sensor_name}
    resource: http://${ip}/server.xml?gettable&update=1
    method: GET
    headers:
      Authorization: "Basic ${token}"
    value_template: >-
      {% set lampe = value_json.data.table | selectattr("uid", "equalto", "${uid}") | list | first %}
      {{ lampe.var | default('0') }}
    scan_interval: ${scan}`;

    const ENTITY =
`light:
  - platform: template
    lights:
      ${slug}:
        friendly_name: "${friendly}"
        unique_id: "light_${slug}"
        turn_on:
          service: rest_command.${rest_on}
        turn_off:
          service: rest_command.${rest_off}
        value_template: >-
          {% set lampe = states('sensor.${sensor_key}') %}
          {{ lampe | int(0) == 100 }}
        availability_template: >-
          {{ states('sensor.${sensor_key}') not in ['unavailable', 'unknown', None, ''] }}`;

    return {REST, SENSOR, ENTITY};
  }

  function buildCover({friendly, slug, ip, uid, token, scan, prefix}){
    const prefixCmd = prefix ? `${prefix}_` : '';
    const rest_pos = `yokis_${prefixCmd}${slug}_set_position`;
    const sensor_name = friendly + ' Brut';
    const sensor_key = sanitizeSlug(friendly)+'_brut';

    const REST =
`rest_command:
  ${rest_pos}:
    url: "http://${ip}/command.xml?action=order&id=${uid}&order=varX&ext1={{ position }}"
    method: get
    headers:
      Authorization: "Basic ${token}"`;

    const SENSOR =
`sensor:
  - platform: rest
    name: ${sensor_name}
    resource: http://${ip}/server.xml?gettable&update=1
    method: GET
    headers:
      Authorization: "Basic ${token}"
    value_template: >-
      {% set volet = value_json.data.table | selectattr("uid", "equalto", "${uid}") | list | first %}
      {{ volet.var | default(0) }}
    unit_of_measurement: "%"
    scan_interval: ${scan}`;

    const ENTITY =
`cover:
  - platform: template
    covers:
      ${slug}:
        friendly_name: "${friendly}"
        unique_id: "cover_${slug}"
        position_template: "{{ states('sensor.${sensor_key}') | int(0) }}"
        set_cover_position:
          service: rest_command.${rest_pos}
          data:
            position: "{{ position }}"
        icon_template: >
          {% set p = states('sensor.${sensor_key}') | int(0) %}
          {% if p == 0 %} mdi:blinds
          {% elif p == 100 %} mdi:blinds-open
          {% else %} mdi:blinds-horizontal
          {% endif %}`;

    return {REST, SENSOR, ENTITY};
  }

  function buildSwitch({friendly, slug, ip, uid, token, scan, prefix}){
    const prefixCmd = prefix ? `${prefix}_` : '';
    const rest_on = `yokis_${prefixCmd}${slug}_on`;
    const rest_off = `yokis_${prefixCmd}${slug}_off`;
    const sensor_name = friendly + ' Etat';
    const sensor_key = sanitizeSlug(friendly)+'_etat';

    const REST =
`rest_command:
  ${rest_on}:
    url: "http://${ip}/command.xml?action=order&id=${uid}&order=on"
    method: get
    headers:
      Authorization: "Basic ${token}"
  ${rest_off}:
    url: "http://${ip}/command.xml?action=order&id=${uid}&order=off"
    method: get
    headers:
      Authorization: "Basic ${token}"`;

    const SENSOR =
`sensor:
  - platform: rest
    name: ${sensor_name}
    resource: http://${ip}/server.xml?gettable&update=1
    method: GET
    headers:
      Authorization: "Basic ${token}"
    value_template: >-
      {% set s = value_json.data.table | selectattr("uid", "equalto", "${uid}") | list | first %}
      {{ s.var | default('0') }}
    scan_interval: ${scan}`;

    const ENTITY =
`switch:
  - platform: template
    switches:
      ${slug}:
        friendly_name: "${friendly}"
        unique_id: "switch_${slug}"
        value_template: >-
          {% set s = states('sensor.${sensor_key}') %}
          {{ s | int(0) == 100 }}
        turn_on:
          service: rest_command.${rest_on}
        turn_off:
          service: rest_command.${rest_off}
        availability_template: >-
          {{ states('sensor.${sensor_key}') not in ['unavailable', 'unknown', None, ''] }}`;

    return {REST, SENSOR, ENTITY};
  }

  function buildAllYaml(blocks){
    return (
`# === rest_command ===
${blocks.REST}

# === sensor ===
${blocks.SENSOR}

# === entity ===
${blocks.ENTITY}
`);
  }

  function generate(){
    const type = elType.value;
    const friendly = ensure(
      elFriendly.value,
      type === 'light' ? 'Lumi√®re Exemple' : type === 'cover' ? 'Volet Exemple' : 'Interrupteur Exemple'
    );
    const slug = sanitizeSlug(
      ensure(elSlug.value, type === 'light' ? 'lumiere_exemple' : type === 'cover' ? 'volet_exemple' : 'interrupteur_exemple')
    );
    const ip = ensure(elIP.value, '192.168.0.156');
    const uid = ensure(elUID.value, type === 'cover' ? 'C84315B9' : 'A111FCC0');
    const token = ensure(elToken.value, 'VOTRE_TOKEN_BASE64_ICI');
    const scan = Math.max(1, parseInt(elScan.value || (type==='cover'?10:5), 10));
    const prefix = sanitizeSlug(elPrefix.value);

    let blocks;
    if(type === 'light'){
      blocks = buildLight({friendly, slug, ip, uid, token, scan, prefix});
    } else if (type === 'cover'){
      blocks = buildCover({friendly, slug, ip, uid, token, scan, prefix});
    } else {
      blocks = buildSwitch({friendly, slug, ip, uid, token, scan, prefix});
    }

    outRest.textContent   = blocks.REST;
    outSensor.textContent = blocks.SENSOR;
    outEntity.textContent = blocks.ENTITY;
    outAll.textContent    = buildAllYaml(blocks);

    [outRest, outSensor, outEntity, outAll].forEach(el => {
      el.classList.add('ok');
      setTimeout(()=>el.classList.remove('ok'), 700);
    });

    outAll.dataset.slug = slug;
    outAll.dataset.type = type;
  }

  function reset(){
    elType.value = 'light';
    elFriendly.value = '';
    elSlug.value = '';
    elIP.value = '';
    elUID.value = '';
    elToken.value = '';
    elScan.value = 5;
    elPrefix.value = '';
    outRest.textContent = '# G√©n√©r√© ici‚Ä¶';
    outSensor.textContent = '# G√©n√©r√© ici‚Ä¶';
    outEntity.textContent = '# G√©n√©r√© ici‚Ä¶';
    outAll.textContent = '# G√©n√©r√© ici‚Ä¶';
  }

  function copyFrom(selector){
    const el = document.querySelector(selector);
    if(!el) return;
    const txt = el.textContent;
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(txt).then(()=>{
        flashBtn(selector, 'Copi√© ‚úì');
      });
    } else {
      const ta = document.createElement('textarea');
      ta.value = txt; document.body.appendChild(ta);
      ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
      flashBtn(selector, 'Copi√© ‚úì');
    }
  }

  function flashBtn(selector, text){
    const b = document.querySelector(`[data-copy="${selector}"]`) || document.querySelector('#copyAllBtn');
    if(!b) return;
    const old = b.textContent;
    b.textContent = text;
    setTimeout(()=> b.textContent = old, 1200);
  }

  function downloadYaml(){
    const content = outAll.textContent || '';
    const slug = outAll.dataset.slug || 'yokis';
    const type = outAll.dataset.type || 'entity';
    const fname = `${slug}_${type}.yaml`;
    const blob = new Blob([content], {type: 'text/yaml;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = fname;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  byId('buildBtn').addEventListener('click', generate);
  byId('resetBtn').addEventListener('click', reset);
  document.querySelectorAll('[data-copy]').forEach(btn=>{
    btn.addEventListener('click', ()=> copyFrom(btn.getAttribute('data-copy')));
  });
  byId('copyAllBtn').addEventListener('click', ()=> copyFrom('#outAll'));
  byId('downloadBtn').addEventListener('click', downloadYaml);

  // Pr√©remplissage d√©mo
  elType.value = 'light';
  elFriendly.value = 'Lumi√®re Terrasse';
  elSlug.value = 'lumiere_terrasse';
  elIP.value = '192.168.0.156';
  elUID.value = 'A111FCC0';
  elToken.value = 'VOTRE_TOKEN_BASE64_ICI';
})();
</script>
</body>
</html>
